/**
 * An AngularJS module for use all Google Apis and your Google Cloud Endpoints
 * @version v0.1.2
 * @link https://github.com/maximepvrt/angular-google-gapi
 */
angular.module("angular-google-gapi",[]),angular.module("angular-google-gapi").factory("GClient",["$document","$q","$timeout","$interval","$window",function($document,$q,$timeout,$interval,$window){function loadScript(src){var deferred=$q.defer(),script=$document[0].createElement("script");return script.onload=function(e){$timeout(function(){deferred.resolve(e)})},script.onerror=function(e){$timeout(function(){deferred.reject(e)})},script.src=src,$document[0].body.appendChild(script),deferred.promise}function load(callback){loadScript(URL).then(function(){var isok=function(callback){void 0!=$window.gapi.client&&(callback(),$interval.cancel(check))};isok(callback);var check=$interval(function(){isok(callback)},10);LOAD_GAE_API=!0})}var LOAD_GAE_API=!1,URL="https://apis.google.com/js/client.js";return{get:function(callback){LOAD_GAE_API?callback():load(callback)}}}]),angular.module("angular-google-gapi").factory("GData",["$rootScope",function($rootScope){$rootScope.gapi={};var isLogin=!1,user=null;return{isLogin:function(value){return 0==arguments.length?isLogin:(isLogin=value,void($rootScope.gapi.login=value))},getUser:function(value){return 0==arguments.length?user:(user=value,void($rootScope.gapi.user=value))}}}]),angular.module("angular-google-gapi").factory("GAuth",["$rootScope","$q","GClient","GApi","GData","$interval","$window","$location",function($rootScope,$q,GClient,GApi,GData,$interval,$window){function load(callback){if(0==isLoad){var args=arguments.length;GClient.get(function(){$window.gapi.client.load("oauth2","v2",function(){isLoad=!0,1==args&&callback()})})}else callback()}function signin(mode,authorizeCallback){load(function(){$window.gapi.auth.authorize({client_id:CLIENT_ID,scope:SCOPE,immediate:mode,response_type:RESPONSE_TYPE},authorizeCallback)})}function offline(){function getCode(event){if("https://accounts.google.com"===event.origin){var data=JSON.parse(event.data);$window.removeEventListener("message",getCode),data=gup(data.a[0],"code"),void 0==data?deferred.reject():deferred.resolve(data)}}function gup(url,name){name=name.replace(/[[]/,"[").replace(/[]]/,"]");var regexS=name+"=([^&#]*)",regex=new RegExp(regexS),results=regex.exec(url);return null==results?void 0:results[1]}var deferred=$q.defer(),origin=$location.protocol+"//"+$location.hostname;""!=$location.port&&(origin=origin+":"+$location.port);$window.open("https://accounts.google.com/o/oauth2/auth?scope="+encodeURI(SCOPE)+"&redirect_uri=postmessage&response_type=code&client_id="+CLIENT_ID+"&access_type=offline&approval_prompt=force&origin="+origin,null,"width=800, height=600");return $window.addEventListener("message",getCode),deferred.promise}function getUser(){var deferred=$q.defer();return $window.gapi.client.oauth2.userinfo.get().execute(function(resp){if(resp.code)deferred.reject();else{GData.isLogin(!0),GApi.executeCallbacks();var user={};user.email=resp.email,user.picture=resp.picture,user.id=resp.id,void 0==resp.name?user.name=resp.email:user.name=resp.name,user.link=resp.link,GData.getUser(user),deferred.resolve()}}),deferred.promise}var CLIENT_ID,isLoad=!1,SCOPE="https://www.googleapis.com/auth/userinfo.email",RESPONSE_TYPE="token id_token";return{setClient:function(client){CLIENT_ID=client},setScope:function(scope){SCOPE=scope},load:function(callback){var args=arguments.length;GClient.get(function(){$window.gapi.client.load("oauth2","v2",function(){1==args&&callback()})})},checkAuth:function(){var deferred=$q.defer();return signin(!0,function(){getUser().then(function(){deferred.resolve()},function(){deferred.reject()})}),deferred.promise},login:function(){var deferred=$q.defer();return signin(!1,function(){getUser().then(function(){deferred.resolve()},function(){deferred.reject()})}),deferred.promise},setToken:function(token){var deferred=$q.defer();return load(function(){$window.gapi.auth.setToken(token),getUser().then(function(){deferred.resolve()},function(){deferred.reject()})}),deferred.promise},getToken:function(){var deferred=$q.defer();return load(function(){deferred.resolve($window.gapi.auth.getToken())}),deferred.promise},logout:function(){var deferred=$q.defer();return load(function(){$window.gapi.auth.setToken(null),GData.isLogin(!1),GData.getUser(null),deferred.resolve()}),deferred.promise},offline:function(){var deferred=$q.defer();return offline().then(function(code){deferred.resolve(code)},function(){deferred.reject()}),deferred.promise}}}]),angular.module("angular-google-gapi").factory("GApi",["$q","GClient","GData","$window",function($q,GClient,GData,$window){function registerObserverCallback(api,method,params,auth,deferred){var observerCallback={};observerCallback.api=api,observerCallback.apiLoad=!1,observerCallback.method=method,observerCallback.params=params,observerCallback.auth=auth,observerCallback.deferred=deferred,observerCallbacks.push(observerCallback)}function load(api,version,url){GClient.get(function(){$window.gapi.client.load(api,version,function(){console.log(api+" "+version+" api loaded"),apisLoad.push(api),executeCallbacks(api)},url)})}function executeCallbacks(api){for(var apiName=api,i=0;i<observerCallbacks.length;i++){var observerCallback=observerCallbacks[i];observerCallback.api!=apiName&&!observerCallback.apiLoad||0!=observerCallback.auth&&1!=GData.isLogin()?observerCallback.api==apiName&&(observerCallbacks[i].apiLoad=!0):(runExecute(observerCallback.api,observerCallback.method,observerCallback.params,observerCallback.deferred),i>-1&&observerCallbacks.splice(i--,1))}}function runExecute(api,method,params,deferred){for(var pathMethod=method.split("."),api=$window.gapi.client[api],i=0;i<pathMethod.length;i++)api=api[pathMethod[i]];api(params).execute(function(response){response.error?deferred.reject(response):deferred.resolve(response)})}function execute(api,method,params,auth){var deferred=$q.defer();return apisLoad.indexOf(api)>-1?runExecute(api,method,params,deferred):registerObserverCallback(api,method,params,auth,deferred),deferred.promise}function request(args){return $window.gapi.client.request(args)}var apisLoad=[],observerCallbacks=[];return{executeCallbacks:function(){executeCallbacks()},load:function(name,version,url){load(name,version,url)},execute:function(api,method,params){return 3==arguments.length?execute(api,method,params,!1):2==arguments.length?execute(api,method,null,!1):void 0},executeAuth:function(api,method,params){return 3==arguments.length?execute(api,method,params,!0):2==arguments.length?execute(api,method,null,!0):void 0},request:function(args){return request(args)},setApiKey:function(apiKey){$window.gapi.client.setApiKey(apiKey)},getGapi:function(){return $window.gapi}}}]);